DROP TABLE Person CASCADE CONSTRAINTS;
DROP TABLE Person_function CASCADE CONSTRAINTS;
DROP TABLE Function CASCADE CONSTRAINTS;
DROP TABLE Appointment CASCADE CONSTRAINTS;
DROP TABLE Bureau CASCADE CONSTRAINTS;
DROP TABLE Bureau_type CASCADE CONSTRAINTS;
DROP TABLE Relationship CASCADE CONSTRAINTS;
DROP TABLE Decree CASCADE CONSTRAINTS;
DROP TABLE Studies CASCADE CONSTRAINTS;
DROP TABLE Studies_student CASCADE CONSTRAINTS;

CREATE TABLE Person (
    Birth_number INTEGER PRIMARY KEY,
    Person_name VARCHAR(30) NOT NULL,
    Surname VARCHAR(30) NOT NULL,
    Sex VARCHAR(1) CHECK (Sex IN ('M', 'F')),
    Noble_title VARCHAR(30),
    CHECK  (Birth_number >= 100000000 AND mod(Birth_number,11)=0)
);

INSERT INTO Person
VALUES (0203071231, 'Jaroslav', 'Streit', 'M', NULL);
INSERT INTO Person
VALUES (0106122467, 'Matěj', 'Nešuta', 'M', 'Rytíř');
INSERT INTO Person
VALUES (9755165673, 'Lenka', 'Zouharová', 'F', 'Hraběnka');
INSERT INTO Person
VALUES (0157068923, 'Patricie', 'Veselá', 'F', NULL);
INSERT INTO Person
VALUES (0157068934, 'Petra', 'Černá', 'F', 'Dáma');
INSERT INTO Person
VALUES (9755165662, 'Vratislava', 'Vyskočilová', 'F', 'Paní');

CREATE TABLE Appointment (
    App_ID NUMBER(10) GENERATED AS IDENTITY (START WITH 1111 INCREMENT BY 1) PRIMARY KEY,
    Appointment VARCHAR(100) NOT NULL UNIQUE
);

INSERT INTO Appointment
VALUES (DEFAULT, 'Jmenovan prezidentem');
INSERT INTO Appointment
VALUES (DEFAULT, 'Prijat ve vyberovem rizeni');

CREATE TABLE Bureau_type (
    Type_ID NUMBER(10) GENERATED AS IDENTITY (START WITH 1111 INCREMENT BY 1) PRIMARY KEY,
    B_type VARCHAR(30) NOT NULL UNIQUE
);

INSERT INTO Bureau_type
VALUES (DEFAULT, 'Mestsky urad');
INSERT INTO Bureau_type
VALUES (DEFAULT, 'Krajsky urad');
INSERT INTO Bureau_type
VALUES (DEFAULT, 'Univerzita');
INSERT INTO Bureau_type
VALUES (DEFAULT, 'Autoskola');

CREATE TABLE Bureau (
    Shortcut VARCHAR(10) PRIMARY KEY,
    Bureau_name VARCHAR(50) NOT NULL,
    B_type_ID NUMBER(10) NOT NULL,
    CONSTRAINT Bureau_ID FOREIGN KEY (B_type_ID) REFERENCES Bureau_type (Type_ID),
    Founded DATE DEFAULT SYSDATE,
    Closed DATE DEFAULT SYSDATE NULL,
    Deed_of_foundation INTEGER NOT NULL UNIQUE,
    Publication_date DATE DEFAULT SYSDATE,
    City VARCHAR(50) NOT NULL,
    Street VARCHAR(50) NOT NULL,
    House_number NUMBER(10) NOT NULL,
    Postal_code NUMBER(5) NOT NULL CHECK(Postal_code > 9999),
    -- pro jednoduchost uvazujeme, ze oblastni pusobnost se vztahuje na oblast, kde se urad nachazi (podle adresy)
    Area_of_operation VARCHAR(10) CHECK (Area_of_operation IN ('Království', 'Země', 'Kraj', 'Okres', 'Obec')),
    Superior_shortcut VARCHAR(10) NULL,
    CONSTRAINT Superior_b FOREIGN KEY (Superior_shortcut) REFERENCES Bureau(Shortcut),
    CONSTRAINT superior_shortcut_shortcut CHECK (Superior_shortcut <> Shortcut),
    CHECK (Founded < Closed),
    CHECK (Deed_of_foundation > 0)
);

INSERT INTO Bureau
VALUES('AutBl', 'Autoskola Blansko', 1111, '11-JAN-1998', NULL, 12345,
       '29-JAN-1998', 'Blansko', 'Hybesova', 69, 67801, 'Okres', NULL);
INSERT INTO Bureau
VALUES('MUBo', 'Mestsky urad Boskovice', 1111, '09-SEP-2000', NULL, 12346,
       DEFAULT, 'Boskovice', 'Janackova', 55, 67802, 'Obec', NULL);
INSERT INTO Bureau
VALUES('KUPh', 'Krajsky urad Praha', 1112, '01-JAN-1993', NULL, 12347,
       DEFAULT, 'Praha', 'Ulice Vaclava Havla', 1, 10000, 'Kraj', NULL);
INSERT INTO Bureau
VALUES('VUTFIT', 'VUT Fakulta informacnich technologii', 1113, '01-JAN-2002', NULL, 12352,
       DEFAULT, 'Brno', 'Bozetechova', 2, 61200, 'Obec', NULL);
INSERT INTO Bureau
VALUES('VUTFP', 'VUT Fakulta podnikatelska', 1113, '15-SEP-1992', NULL, 12353,
       DEFAULT, 'Brno', 'Kolejni', 2906, 61200, 'Obec', 'VUTFIT');
INSERT INTO Bureau
VALUES('AutBrKrp', 'Autoskola Brno - Kralovo pole', 1111, '15-SEP-1994', NULL, 12354,
       DEFAULT, 'Brno', 'Purkynova', 2906, 61200, 'Obec', NULL);


CREATE TABLE Function (
    Function_ID NUMBER(10) GENERATED BY DEFAULT AS IDENTITY (START WITH 1111 INCREMENT BY 1),
    Function_name VARCHAR(50)  NOT NULL,
    Function_code INTEGER NOT NULL,
    App_ID NUMBER (10),
    Function_length INTERVAL YEAR(4) TO MONTH DEFAULT INTERVAL '0000-00' YEAR TO MONTH,
    Superior_ID NUMBER(10) NULL,
    Establishment_date DATE DEFAULT SYSDATE,
    Cancellation_date DATE DEFAULT SYSDATE,
    Shortcut VARCHAR(10),
    CONSTRAINT Appointment_ID FOREIGN KEY (App_ID) REFERENCES Appointment(App_ID),
    CONSTRAINT Superior_f FOREIGN KEY (Superior_ID) REFERENCES Function(Function_ID),
    CONSTRAINT Function_ID UNIQUE (Function_ID),
    CONSTRAINT Fc_Bureau FOREIGN KEY (Shortcut) REFERENCES Bureau(Shortcut),
    CONSTRAINT func_in_bur UNIQUE (Function_code, Shortcut),
    CHECK (Function_code > 0)
);

INSERT INTO Function
VALUES(DEFAULT, 'Instruktor', 1234, 1111, DEFAULT, NULL, DEFAULT, DEFAULT, 'AutBl');
INSERT INTO Function
VALUES(DEFAULT, 'Sekretarka', 1234, 1112, DEFAULT, 1111, DEFAULT, DEFAULT, 'MUBo');
INSERT INTO Function
VALUES(DEFAULT, 'Administrator systemu', 1357, 1112, DEFAULT, NULL, DEFAULT, DEFAULT, 'KUPh');
INSERT INTO Function
VALUES(DEFAULT, 'Profesor', 1313, 1111, DEFAULT, NULL, DEFAULT, DEFAULT, 'VUTFIT');


CREATE TABLE Person_function (
    Table_ID NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    Function_ID NUMBER(10),
    Date_from DATE DEFAULT SYSDATE NOT NULL,
    Date_to DATE DEFAULT SYSDATE,
    Employee_order NUMBER(5) NOT NULL,
    End_reason VARCHAR(150),
    Birth_number INTEGER,
    CONSTRAINT VALID_INTERVAL CHECK (Date_to > Date_from),
    CONSTRAINT Person_ID FOREIGN KEY (Birth_number) REFERENCES Person (Birth_number),
    CONSTRAINT Func_ID FOREIGN KEY (Function_ID) REFERENCES Function (Function_ID)
);

INSERT INTO Person_function
VALUES(DEFAULT, 1111, '07-MAR-2019', DEFAULT, 7, 'Nikdo nevi', 0203071231);
INSERT INTO Person_function
VALUES(DEFAULT, 1112, '11-MAR-2012', DEFAULT, 3,
       'Nesplnovani pracovni doby, alkoholismus na pracovisti', 9755165673);
INSERT INTO Person_function
VALUES(DEFAULT, 1113, '21-JUN-2016', NULL, 2, NULL, 0106122467);
INSERT INTO Person_function
VALUES(DEFAULT, 1114, '13-MAY-2021', NULL, 9, NULL, 0157068923);
INSERT INTO Person_function
VALUES(DEFAULT, 1112, '22-MAY-2017', NULL, 9, NULL, 0157068934);

CREATE TABLE Relationship (
    relationship_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    Person_1 INTEGER NOT NULL,
    Person_2 INTEGER NOT NULL,
    rel_type VARCHAR(20) CHECK (rel_type IN ('Family member', 'School', 'Work', 'Other')),
    rel_description VARCHAR(1000),
    CONSTRAINT Person_ID1 FOREIGN KEY (Person_1) REFERENCES Person (Birth_number),
    CONSTRAINT Person_ID2 FOREIGN KEY (Person_2) REFERENCES Person (Birth_number),
    constraint uq1 unique (person_1, person_2),
    CHECK (person_1 <> person_2)
);

INSERT INTO Relationship
VALUES(DEFAULT, '0203071231', '9755165673', 'Family member', 'Sestra');
INSERT INTO Relationship
VALUES(DEFAULT, '0157068934', '9755165662', 'Family member', 'Sestrenice');

CREATE TABLE Decree (
    Decree_ID INTEGER PRIMARY KEY,
    Date_of_decision DATE DEFAULT SYSDATE,
    Date_of_execution DATE DEFAULT SYSDATE,
    Decree VARCHAR(200) NOT NULL,
    Reasoning VARCHAR(1000) NOT NULL,
    Birth_number INTEGER,
    Shortcut VARCHAR(10),
    CONSTRAINT D_person FOREIGN KEY (Birth_number) REFERENCES Person (Birth_number),
    CONSTRAINT D_bureau FOREIGN KEY (Shortcut) REFERENCES Bureau (Shortcut),
    CHECK (Decree_ID > 0)
);

INSERT INTO Decree
VALUES(731476, DEFAULT, '21-JUN-2016', 'Vydani ridicskeho prukazu',
       'Ridicsky prukaz vydan na zaklade plnohodnotneho splneni autoskoly.', '0203071231', 'AutBl');
INSERT INTO Decree
VALUES(731482, DEFAULT, '13-FEB-2019', 'Vydani ridicskeho prukazu',
       'Ridicsky prukaz vydan na zaklade plnohodnotneho splneni autoskoly.', '0203071231', 'AutBl');
INSERT INTO Decree
VALUES(725341,'10-JAN-2020', '20-JAN-2020', 'Vypsani zakazky na nova vozidla.',
       'Stavajici vozovy park nestacil', '0203071231', 'AutBl');
INSERT INTO Decree
VALUES(266435,'10-JAN-2020', '20-JAN-2020', 'Nakup kavovaru do vestibulu.',
       'Do vestibulu autoskoly bude pro studenty nainstalovan kavovar spolecnost Cafe&Co.', '0203071231', 'AutBl');


-- Po feedbacku z 1. casti jsme se rozhodli komplet predelat specializaci a misto uzemnich celku ji
-- aplikovat na entitni mnozinu studii. Ta by vypadala tak, ze by byla specializovana na 
-- bakalarska studia, pobakalarska studia (inzenyrska, doktorska, kurzy a certifikaty) a na 
-- kurzy ovladani motorovych vozidel. Tyto 3 specializace by mely spolecny primarni klic kodu.

-- Pro skript jsme se rozhodli tuto specializaci vtesnat do jedne tabulky, jelikoz se jedna o specializaci
-- disjunktni a totalni a toto reseni by tomu mohlo vyhovovat nejlepe.

CREATE TABLE Studies(
    Studies_ID INTEGER PRIMARY KEY,
    Studies_name VARCHAR(50) NOT NULL,
    Shortcut VARCHAR(10),
    Type_ VARCHAR(25) NOT NULL CHECK (Type_ IN ('Postgraduate certificates', 'Postgraduate diplomas', 'Master''s degrees', 'Doctorates','Bachelor''s', 'Driving schools')),
    vehicle_type VARCHAR(20) NULL CHECK (vehicle_type IN ('A','B','BE','C','CE','D', 'DE', 'T', 'Others')),
    CONSTRAINT B_bureau FOREIGN KEY (Shortcut) REFERENCES  Bureau (Shortcut),
    CHECK (Studies_ID > 0),
    CHECK ((Type_ like 'Driving schools' and vehicle_type is not NULL) or 
    (Type_ not like 'Driving schools' and vehicle_type is NULL))
);

INSERT INTO Studies
VALUES(12, 'Manazerska Informatika', 'VUTFP', 'Bachelor''s', NULL);
INSERT INTO Studies
VALUES(102, 'Informacni technologie', 'VUTFIT', 'Postgraduate diplomas', NULL);
INSERT INTO Studies
VALUES(441, 'Ridicske opravneni B', 'AutBl', 'Driving schools', 'B');
INSERT INTO Studies
VALUES(442, 'Ridicske opravneni BE', 'AutBl', 'Driving schools', 'BE');
INSERT INTO Studies
VALUES(443, 'Ridicske opravneni A', 'AutBl', 'Driving schools', 'A');
INSERT INTO Studies
VALUES(444, 'Ridicske opravneni C', 'AutBl', 'Driving schools', 'C');
INSERT INTO Studies
VALUES(460, 'Ridicske opravneni B', 'AutBrKrp', 'Driving schools', 'B');

CREATE TABLE Studies_student (
    Table_ID NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    Date_from DATE DEFAULT SYSDATE,
    Date_to DATE DEFAULT SYSDATE NULL,
    Successful_end VARCHAR(3) CHECK (Successful_end IN ('YES', 'NO')) NULL,
    Studies_ID NUMBER(10),
    Birth_number INTEGER,
    CONSTRAINT Studies_1 FOREIGN KEY (Studies_ID) REFERENCES  Studies (Studies_ID),
    CONSTRAINT Student_1 FOREIGN KEY (Birth_number) REFERENCES  Person (Birth_number)
);

INSERT INTO Studies_student
VALUES(DEFAULT, '21-SEP-2017', '14-JUL-2022', 'YES', 102, 0203071231);
INSERT INTO Studies_student
VALUES(DEFAULT, '11-AUG-2021', NULL, NULL, 441, 0203071231);
INSERT INTO Studies_student
VALUES(DEFAULT, '18-SEP-2018', '29-JUN-2021', 'YES', 12, 9755165673);
INSERT INTO Studies_student
VALUES(DEFAULT, '24-SEP-2016', '23-JUL-2022', 'YES', 102, 0106122467);
INSERT INTO Studies_student
VALUES(DEFAULT, '29-SEP-2015', '23-JUL-2019', 'NO', 12, 9755165662);
INSERT INTO Studies_student
VALUES(DEFAULT, '11-SEP-2016', '21-DEC-2016', 'YES', 442, 9755165673);
INSERT INTO Studies_student
VALUES(DEFAULT, '30-AUG-2017', '21-DEC-2018', 'YES', 443, 0157068923);
INSERT INTO Studies_student
VALUES(DEFAULT, '24-SEP-2022', '13-FEB-2023', 'NO', 444, 0157068934);
INSERT INTO Studies_student
VALUES(DEFAULT, '11-AUG-2013', '17-JUN-2015', 'YES', 460, 9755165662);


-- Tento dotaz vypisuje vsechny studijni obory a kurzy a take urad, ktery tyto kurzy/obory zarizuje.
SELECT Shortcut, Bureau_name, Studies_name
FROM Bureau NATURAL JOIN Studies;

-- Tento dotaz vypise 2 ruzne osoby, ktere spolu jsou v nejakem urcitem vztahu. Dale pak specifikaci vztahu a jeho popis.
SELECT Person_1, p1.Person_name, p1.Surname, Person_2, p2.Person_name, p2.Surname, rel_type, rel_description
FROM Relationship JOIN Person p1 ON p1.Birth_number = Person_1 JOIN Person p2 on p2.Birth_number = Person_2;

-- Tento dotaz vypisuje vsechna rozhodnuti vykonana na urcitem urade od urciteho data a kdo dane rozhodnuti vykonal (v tomto pripade se jedna Autoskolu Blansko a rozhodnuti od roku 2018).
SELECT Shortcut, Person_name, Surname, Decree_ID, Decree
FROM Decree NATURAL JOIN Person NATURAL JOIN Bureau
WHERE Bureau_name = 'Autoskola Blansko' AND Date_of_execution > TO_DATE('01-JAN-2018');

-- Vypise celkovy pocet osob v systemu podle pohlavi.
SELECT Sex, COUNT(*) Pocet_uredniku
FROM Person NATURAL JOIN Person_function NATURAL JOIN Function
GROUP BY Sex ORDER BY Pocet_uredniku DESC;
-- Ukaze podle oboru pocet studentu, kteri minule roky uspesne ukoncili studium. 
SELECT Studies_ID, STUDIES_NAME, BUREAU_name, COUNT(STUDIES_ID) Pocet_uspesnych_studentu 
FROM Studies NATURAL JOIN Studies_student NATURAL JOIN Bureau
WHERE Successful_end = 'YES' AND Date_to < TO_DATE('01-JAN-2023') AND Date_to IS NOT NULL
GROUP BY Studies_ID, STUDIES_name, Bureau_name;

-- Tento dotaz vypise vsechny urady, na kterych pracuje alespon 1 clovek s slechtickym titulem
SELECT Shortcut, Bureau_name
FROM Bureau
WHERE EXISTS(SELECT Birth_number, Noble_title
FROM Function NATURAL JOIN Person_function NATURAL JOIN Person
WHERE Bureau.Shortcut = Function.Shortcut AND Noble_title IS NOT NULL);

-- Dotaz, ktery vypise vsechny osoby, ktere uspesne ukoncily nejakou formu kurzu motoroveho vozidla.
SELECT DISTINCT Person_name, Surname FROM Person WHERE Birth_number IN
(SELECT Studies_student.Birth_number FROM Studies_student NATURAL JOIN Studies
 where Studies.Type_ = 'Driving schools' AND Successful_end = 'YES');
